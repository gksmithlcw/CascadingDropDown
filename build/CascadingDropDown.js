// Generated by CoffeeScript 1.3.1

/*
CascadingDropDown jQuery plugin. https://github.com/shawnmclean/CascadingDropDown
Copyright (c) 2012 Shawn Mclean and CascadingDropDown.js contributors
*/


(function() {

  (function($) {
    return $.fn.CascadingDropDown = function(source, actionPath, options) {
      var optionTag, settings;
      if (!source) {
        throw "A source element is required";
      }
      if (!actionPath) {
        throw "An action path is requried";
      }
      settings = $.extend({
        promptText: "-- Select --",
        loadingText: "Loading ..",
        errorText: "Error loading data.",
        postData: null,
        onLoading: null,
        onLoaded: null,
        onError: null
      }, options);
      optionTag = "<option></option>";
      return this.each(function() {
        var $this, clear, initialize, loaded, post, postError, reset;
        $this = $(this);
        $(source).on('change', function() {
          var parent;
          parent = $(this);
          if (parent.val() !== "") {
            return post();
          } else {
            return reset();
          }
        });
        initialize = function() {
          if ($this.children().size() === 0) {
            reset();
          }
          if ($(source).val()) {
            return post();
          }
        };
        clear = function() {
          $this.empty();
          return $this.attr("disabled", "disabled");
        };
        reset = function() {
          clear();
          return $this.append($(optionTag).attr("value", "").text(settings.promptText));
        };
        loaded = function() {
          return $this.removeAttr("disabled");
        };
        postError = function() {
          clear();
          $this.append($(optionTag).attr("value", "").text(settings.errorText));
          return $.isFunction(settings.onError) && settings.onError.call($this);
        };
        post = function() {
          $.isFunction(settings.onLoading) && settings.onLoading.call($this);
          return $.ajax({
            url: actionPath,
            type: "POST",
            dataType: "json",
            data: settings.postData || $(source).serialize(),
            success: function(data) {
              reset();
              $.each(data, function() {
                return $this.append($(settings.optionTag).attr("value", this.Value).text(this.Text));
              });
              loaded();
              return $.isFunction(settings.onLoaded) && settings.onLoaded.call($this);
            },
            error: function() {
              return postError();
            }
          });
        };
        loaded = function() {
          return $this.removeAttr('disabled');
        };
        return initialize();
      });
    };
  })(jQuery);

}).call(this);
